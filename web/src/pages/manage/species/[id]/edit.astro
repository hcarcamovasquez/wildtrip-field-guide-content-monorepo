---
import PrivateHeader from '../../../../components/manage/PrivateHeader.astro'
import SpeciesForm from '../../../../components/manage/SpeciesForm.tsx'
import Layout from '../../../../layouts/Layout.astro'
import { ManageSpeciesRepository } from '../../../../lib/private/repositories/ManageSpeciesRepository'
import { canAccessRoute, type Role } from '../../../../lib/utils/permissions'

const user = Astro.locals.user
if (!user) {
  return Astro.redirect('/sign-in')
}

if (!canAccessRoute(user.role as Role, Astro.url.pathname)) {
  return Astro.redirect('/unauthorized')
}

const { id } = Astro.params
const speciesId = parseInt(id as string)

const species = await ManageSpeciesRepository.findByIdWithDetails(speciesId)
if (!species) {
  return new Response('Especie no encontrada', { status: 404 })
}

// Check if this is a new species from the create modal
const isNewFromModal = Astro.url.searchParams.get('new') === 'true'
---

<Layout title={`Editar ${species.commonName || species.scientificName} - Panel de AdministraciÃ³n`}>
  <PrivateHeader slot="header" />
  <SpeciesForm client:load species={species} currentUserId={user.id} isEditing={!isNewFromModal} />
</Layout>
