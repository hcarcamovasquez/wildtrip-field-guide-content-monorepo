---
import Layout from '@/layouts/Layout.astro'
import { apiClient } from '@/lib/api/client'

// Get the preview ID from params
const { id } = Astro.params

// Check if user is authenticated by checking cookies
const sessionCookie = Astro.cookies.get('__session')

if (!sessionCookie) {
  // Redirect to sign-in if not authenticated
  return Astro.redirect('/sign-in')
}

let species
let error

try {
  // Fetch the preview data (includes drafts)
  species = await apiClient.preview.species(Number(id))
} catch (e) {
  error = e instanceof Error ? e.message : 'Failed to load preview'
}

if (error || !species) {
  return Astro.redirect('/404')
}
---

<Layout title={`Preview: ${species.commonName}`}>
  <div class="container mx-auto px-4 py-8">
    <div class="max-w-4xl mx-auto">
      <!-- Preview Banner -->
      <div class="bg-yellow-100 border-l-4 border-yellow-500 text-yellow-700 p-4 mb-6">
        <p class="font-bold">Preview Mode</p>
        <p class="text-sm">
          You are viewing a preview. 
          {species.isDraft && <span class="font-semibold">This includes unpublished draft changes.</span>}
        </p>
      </div>

      <!-- Species Content -->
      <h1 class="text-4xl font-bold mb-2">{species.commonName}</h1>
      <p class="text-xl text-gray-600 italic mb-6">{species.scientificName}</p>
      
      {species.status === 'draft' && (
        <div class="inline-block bg-gray-200 text-gray-700 px-3 py-1 rounded mb-4">
          Draft
        </div>
      )}

      <div class="prose prose-lg max-w-none">
        <p>{species.description}</p>
      </div>

      <!-- Action Buttons -->
      <div class="mt-8 flex gap-4">
        <a 
          href={`${import.meta.env.PUBLIC_ADMIN_URL}/species/edit/${id}`}
          class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700"
        >
          Edit in Dashboard
        </a>
        <a 
          href="/content/species"
          class="bg-gray-200 text-gray-700 px-4 py-2 rounded hover:bg-gray-300"
        >
          Back to Species List
        </a>
      </div>
    </div>
  </div>
</Layout>