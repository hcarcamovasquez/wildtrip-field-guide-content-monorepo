---
import Layout from '@/layouts/Layout.astro'
import { apiClient } from '@/lib/api/client'

// Get the preview ID from params
const { id } = Astro.params

// Check if user is authenticated by checking cookies
const sessionCookie = Astro.cookies.get('__session')

if (!sessionCookie) {
  // Redirect to sign-in if not authenticated
  return Astro.redirect('/sign-in')
}

let area
let error

try {
  // Fetch the preview data (includes drafts)
  area = await apiClient.preview.protectedAreas(Number(id))
} catch (e) {
  error = e instanceof Error ? e.message : 'Failed to load preview'
}

if (error || !area) {
  return Astro.redirect('/404')
}
---

<Layout title={`Preview: ${area.name}`}>
  <div class="container mx-auto px-4 py-8">
    <div class="mx-auto max-w-4xl">
      <!-- Preview Banner -->
      <div class="mb-6 border-l-4 border-yellow-500 bg-yellow-100 p-4 text-yellow-700">
        <p class="font-bold">Preview Mode</p>
        <p class="text-sm">
          You are viewing a preview.
          {area.isDraft && <span class="font-semibold">This includes unpublished draft changes.</span>}
        </p>
      </div>

      <!-- Protected Area Content -->
      <h1 class="mb-2 text-4xl font-bold">{area.name}</h1>
      <p class="mb-6 text-xl text-gray-600">{area.type}</p>

      {
        area.status === 'draft' && (
          <div class="mb-4 inline-block rounded bg-gray-200 px-3 py-1 text-gray-700">Draft</div>
        )
      }

      <div class="prose prose-lg max-w-none">
        <p>{area.description}</p>
      </div>

      <!-- Action Buttons -->
      <div class="mt-8 flex gap-4">
        <a
          href={`${import.meta.env.PUBLIC_ADMIN_URL}/protected-areas/edit/${id}`}
          class="rounded bg-blue-600 px-4 py-2 text-white hover:bg-blue-700"
        >
          Edit in Dashboard
        </a>
        <a href="/content/protected-areas" class="rounded bg-gray-200 px-4 py-2 text-gray-700 hover:bg-gray-300">
          Back to Protected Areas List
        </a>
      </div>
    </div>
  </div>
</Layout>
