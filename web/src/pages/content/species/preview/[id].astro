---
import Eye from '../../../../components/public/icons/Eye.astro'
import SpeciesDetail from '../../../../components/public/species/SpeciesDetail.astro'
import Layout from '../../../../layouts/Layout.astro'
import { ManageSpeciesRepository } from '../../../../lib/private/repositories/ManageSpeciesRepository'
import { canAccessRoute, type Role } from '../../../../lib/utils/permissions'

const user = Astro.locals.user
if (!user) {
  return Astro.redirect('/sign-in')
}

if (!canAccessRoute(user.role as Role, '/manage/species')) {
  return new Response('No autorizado', { status: 403 })
}

const { id } = Astro.params
const speciesId = parseInt(id as string)

const speciesData = await ManageSpeciesRepository.getPreviewData(speciesId)
if (!speciesData) {
  return new Response('Especie no encontrada', { status: 404 })
}
---

<Layout
  title={`${speciesData.commonName || speciesData.scientificName} - Vista previa`}
  description={speciesData.scientificName}
>
  <!-- Preview notice banner -->
  <div class="sticky top-0 z-50 bg-orange-500 text-white">
    <div class="mx-auto max-w-4xl px-4 py-2 sm:px-6 lg:px-8">
      <div class="flex items-center justify-center">
        <div class="flex items-center gap-2">
          <Eye class="h-5 w-5" />
          <span class="text-sm font-medium">
            {
              // @ts-ignore - Preview-specific properties
              speciesData._hasDraft && speciesData._status === 'published'
                ? 'Vista previa del borrador - Los cambios no son p√∫blicos hasta que se publiquen'
                : 'Vista previa'
            }
          </span>
        </div>
      </div>
    </div>
  </div>

  <SpeciesDetail species={speciesData} />
</Layout>
