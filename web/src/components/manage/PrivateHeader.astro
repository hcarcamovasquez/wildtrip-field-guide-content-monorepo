---
import { SignedIn, UserButton } from '@clerk/astro/components'

import { canAccessRoute, type Role } from '../../lib/utils/permissions'
import DarkModeToggle from '../public/DarkModeToggle.astro'
import Bird from '../public/icons/Bird.astro'
import Camera from '../public/icons/Camera.astro'
import ChartBar from '../public/icons/ChartBar.astro'
import ChevronLeft from '../public/icons/ChevronLeft.astro'
import Menu from '../public/icons/Menu.astro'
import Mountain from '../public/icons/Mountain.astro'
import Newspaper from '../public/icons/Newspaper.astro'
import Users from '../public/icons/Users.astro'

// Get current path to determine active section
const currentPath = Astro.url.pathname

// Get current user from locals (set by middleware)
const currentUser = Astro.locals.user
const userRole = currentUser?.role as Role | undefined

const logo = import.meta.env.PUBLIC_R2_PUBLIC_URL + '/colored_logo.svg'
---

<header class="border-b border-gray-200 bg-white shadow-sm dark:border-gray-700 dark:bg-gray-800" id="main-header">
  <!-- Primera línea: Logo y acciones de usuario -->
  <nav class="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8">
    <div class="flex h-16 justify-between">
      <div class="flex items-center">
        <a href="/" class="flex items-center">
          <div class="flex flex-col">
            <span class="text-lg font-bold text-gray-900 dark:text-white">Guía de Campo</span>
            <div class="flex items-center gap-2">
              <span class="text-xs text-gray-500 dark:text-gray-400">un servicio de</span>
              <img src={logo} alt="Wildtrip" class="h-4 w-auto" />
            </div>
          </div>
        </a>
      </div>

      <div class="hidden sm:flex sm:items-center sm:gap-4">
        <DarkModeToggle />

        <!-- Clerk Auth Components -->
        <div class="flex items-center gap-4">
          <SignedIn>
            <a
              href="/"
              class="flex items-center gap-2 rounded-lg bg-gray-200 px-4 py-2 text-sm font-medium text-gray-800 transition-colors hover:bg-gray-300 dark:bg-gray-700 dark:text-white dark:hover:bg-gray-600"
            >
              <ChevronLeft class="h-4 w-4" />
              Volver al sitio
            </a>
            <UserButton
              appearance={{
                elements: {
                  avatarBox: 'w-8 h-8',
                },
              }}
            />
          </SignedIn>
        </div>
      </div>

      <!-- Mobile menu button -->
      <div class="flex items-center gap-2 sm:hidden">
        <SignedIn>
          <a href="/" class="rounded-lg p-2 text-gray-700 hover:bg-gray-100 dark:text-gray-300 dark:hover:bg-gray-700">
            <ChevronLeft class="h-5 w-5" />
          </a>
          <UserButton
            appearance={{
              elements: {
                avatarBox: 'w-8 h-8',
              },
            }}
          />
        </SignedIn>
        <DarkModeToggle />
        <button
          type="button"
          class="inline-flex items-center justify-center rounded-md p-2 text-gray-700 hover:bg-gray-100 hover:text-primary focus:ring-2 focus:ring-primary focus:outline-none focus:ring-inset dark:text-gray-300 dark:hover:bg-gray-700 dark:hover:text-emerald-400"
          aria-controls="mobile-menu"
          aria-expanded="false"
          id="mobile-menu-button"
        >
          <span class="sr-only">Abrir menú principal</span>
          <Menu class="h-6 w-6" />
        </button>
      </div>
    </div>
  </nav>

  <!-- Segunda línea: Menú de navegación (solo desktop) -->
  <nav class="hidden border-t border-gray-100 bg-gray-50 sm:block dark:border-gray-700 dark:bg-gray-900">
    <div class="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8">
      <div class="flex h-12 items-center justify-center space-x-8">
        {
          userRole && canAccessRoute(userRole, '/manage') && (
            <a
              href="/manage"
              class={`relative flex items-center gap-2 px-3 py-2 text-sm font-medium transition-all ${
                currentPath === '/manage'
                  ? 'text-primary after:absolute after:right-0 after:bottom-0 after:left-0 after:h-0.5 after:bg-primary dark:text-emerald-400 dark:after:bg-emerald-400'
                  : 'text-gray-700 hover:text-primary dark:text-gray-300 dark:hover:text-emerald-400'
              }`}
            >
              <ChartBar class="h-4 w-4" />
              Dashboard
            </a>
          )
        }
        {
          userRole && canAccessRoute(userRole, '/manage/species') && (
            <a
              href="/manage/species"
              class={`relative flex items-center gap-2 px-3 py-2 text-sm font-medium transition-all ${
                currentPath.includes('/manage/species')
                  ? 'text-primary after:absolute after:right-0 after:bottom-0 after:left-0 after:h-0.5 after:bg-primary dark:text-emerald-400 dark:after:bg-emerald-400'
                  : 'text-gray-700 hover:text-primary dark:text-gray-300 dark:hover:text-emerald-400'
              }`}
            >
              <Bird class="h-4 w-4" />
              Especies
            </a>
          )
        }
        {
          userRole && canAccessRoute(userRole, '/manage/protected-areas') && (
            <a
              href="/manage/protected-areas"
              class={`relative flex items-center gap-2 px-3 py-2 text-sm font-medium transition-all ${
                currentPath.includes('/manage/protected-areas')
                  ? 'text-primary after:absolute after:right-0 after:bottom-0 after:left-0 after:h-0.5 after:bg-primary dark:text-emerald-400 dark:after:bg-emerald-400'
                  : 'text-gray-700 hover:text-primary dark:text-gray-300 dark:hover:text-emerald-400'
              }`}
            >
              <Mountain class="h-4 w-4" />
              Áreas Protegidas
            </a>
          )
        }
        {
          userRole && canAccessRoute(userRole, '/manage/news') && (
            <a
              href="/manage/news"
              class={`relative flex items-center gap-2 px-3 py-2 text-sm font-medium transition-all ${
                currentPath.includes('/manage/news')
                  ? 'text-primary after:absolute after:right-0 after:bottom-0 after:left-0 after:h-0.5 after:bg-primary dark:text-emerald-400 dark:after:bg-emerald-400'
                  : 'text-gray-700 hover:text-primary dark:text-gray-300 dark:hover:text-emerald-400'
              }`}
            >
              <Newspaper class="h-4 w-4" />
              Noticias
            </a>
          )
        }
        {
          userRole && canAccessRoute(userRole, '/manage/gallery') && (
            <a
              href="/manage/gallery"
              class={`relative flex items-center gap-2 px-3 py-2 text-sm font-medium transition-all ${
                currentPath.includes('/manage/gallery')
                  ? 'text-primary after:absolute after:right-0 after:bottom-0 after:left-0 after:h-0.5 after:bg-primary dark:text-emerald-400 dark:after:bg-emerald-400'
                  : 'text-gray-700 hover:text-primary dark:text-gray-300 dark:hover:text-emerald-400'
              }`}
            >
              <Camera class="h-4 w-4" />
              Galería
            </a>
          )
        }
        {
          userRole && canAccessRoute(userRole, '/manage/users') && (
            <a
              href="/manage/users"
              class={`relative flex items-center gap-2 px-3 py-2 text-sm font-medium transition-all ${
                currentPath.includes('/manage/users')
                  ? 'text-primary after:absolute after:right-0 after:bottom-0 after:left-0 after:h-0.5 after:bg-primary dark:text-emerald-400 dark:after:bg-emerald-400'
                  : 'text-gray-700 hover:text-primary dark:text-gray-300 dark:hover:text-emerald-400'
              }`}
            >
              <Users class="h-4 w-4" />
              Usuarios
            </a>
          )
        }
      </div>
    </div>
  </nav>

  <!-- Mobile menu -->
  <div class="hidden sm:hidden" id="mobile-menu">
    <div class="space-y-1 border-t border-gray-200 bg-white px-2 pt-2 pb-3 dark:border-gray-700 dark:bg-gray-800">
      <!-- Management mobile navigation items based on user permissions -->
      {
        userRole && canAccessRoute(userRole, '/manage') && (
          <a
            href="/manage"
            class={`flex items-center gap-2 rounded-md px-3 py-2 text-base font-medium text-gray-700 hover:bg-gray-50 hover:text-primary dark:text-gray-300 dark:hover:bg-gray-700 dark:hover:text-emerald-400 ${
              currentPath === '/manage' ? 'text-primary dark:text-emerald-400' : ''
            }`}
          >
            <ChartBar class="h-5 w-5" />
            Dashboard
          </a>
        )
      }
      {
        userRole && canAccessRoute(userRole, '/manage/species') && (
          <a
            href="/manage/species"
            class={`flex items-center gap-2 rounded-md px-3 py-2 text-base font-medium text-gray-700 hover:bg-gray-50 hover:text-primary dark:text-gray-300 dark:hover:bg-gray-700 dark:hover:text-emerald-400 ${
              currentPath.includes('/manage/species') ? 'text-primary dark:text-emerald-400' : ''
            }`}
          >
            <Bird class="h-5 w-5" />
            Especies
          </a>
        )
      }
      {
        userRole && canAccessRoute(userRole, '/manage/protected-areas') && (
          <a
            href="/manage/protected-areas"
            class={`flex items-center gap-2 rounded-md px-3 py-2 text-base font-medium text-gray-700 hover:bg-gray-50 hover:text-primary dark:text-gray-300 dark:hover:bg-gray-700 dark:hover:text-emerald-400 ${
              currentPath.includes('/manage/protected-areas') ? 'text-primary dark:text-emerald-400' : ''
            }`}
          >
            <Mountain class="h-5 w-5" />
            Áreas Protegidas
          </a>
        )
      }
      {
        userRole && canAccessRoute(userRole, '/manage/news') && (
          <a
            href="/manage/news"
            class={`flex items-center gap-2 rounded-md px-3 py-2 text-base font-medium text-gray-700 hover:bg-gray-50 hover:text-primary dark:text-gray-300 dark:hover:bg-gray-700 dark:hover:text-emerald-400 ${
              currentPath.includes('/manage/news') ? 'text-primary dark:text-emerald-400' : ''
            }`}
          >
            <Newspaper class="h-5 w-5" />
            Noticias
          </a>
        )
      }
      {
        userRole && canAccessRoute(userRole, '/manage/gallery') && (
          <a
            href="/manage/gallery"
            class={`flex items-center gap-2 rounded-md px-3 py-2 text-base font-medium text-gray-700 hover:bg-gray-50 hover:text-primary dark:text-gray-300 dark:hover:bg-gray-700 dark:hover:text-emerald-400 ${
              currentPath.includes('/manage/gallery') ? 'text-primary dark:text-emerald-400' : ''
            }`}
          >
            <Camera class="h-5 w-5" />
            Galería
          </a>
        )
      }
      {
        userRole && canAccessRoute(userRole, '/manage/users') && (
          <a
            href="/manage/users"
            class={`flex items-center gap-2 rounded-md px-3 py-2 text-base font-medium text-gray-700 hover:bg-gray-50 hover:text-primary dark:text-gray-300 dark:hover:bg-gray-700 dark:hover:text-emerald-400 ${
              currentPath.includes('/manage/users') ? 'text-primary dark:text-emerald-400' : ''
            }`}
          >
            <Users class="h-5 w-5" />
            Usuarios
          </a>
        )
      }

      <!-- Mobile Back Link -->
      <SignedIn>
        <div class="mt-2 border-t border-gray-200 pt-2 dark:border-gray-700">
          <a
            href="/"
            class="flex items-center gap-2 rounded-md px-3 py-2 text-base font-medium text-gray-700 hover:bg-gray-50 hover:text-primary dark:text-gray-300 dark:hover:bg-gray-700 dark:hover:text-emerald-400"
          >
            <ChevronLeft class="h-5 w-5" />
            Volver al sitio
          </a>
        </div>
      </SignedIn>
    </div>
  </div>
</header>

<script>
  const mobileMenuButton = document.getElementById('mobile-menu-button')
  const mobileMenu = document.getElementById('mobile-menu')

  mobileMenuButton?.addEventListener('click', () => {
    const isExpanded = mobileMenuButton.getAttribute('aria-expanded') === 'true'
    mobileMenuButton.setAttribute('aria-expanded', (!isExpanded).toString())
    mobileMenu?.classList.toggle('hidden')
  })
</script>
